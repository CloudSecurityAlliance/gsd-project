#!/usr/bin/env python3

import csv
import re
import os

os.system("wget -q https://cve.mitre.org/data/downloads/allitems.csv.gz")
os.system("gzip -d allitems.csv.gz")

CVEAssignedYears = {1999: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2000: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2001: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2002: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2003: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2004: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2005: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2006: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2007: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2008: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2009: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2010: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2011: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2012: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2013: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2014: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2015: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2016: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2017: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2018: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2019: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2020: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2021: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0},
                    2022: {"CVEsforCurrentYear":0, "CVEsForPreviousYears":0}
}

with open('allitems.csv', newline='',  encoding='ISO-8859-1') as csvfile:
    cvereader= csv.reader(csvfile, delimiter=',', quotechar='"')
    for row in cvereader:
        if re.search('^CVE-', row[0]):
            # Ignore reserved
            if re.search('^\*\* RESERVED \*\* ', row[2]):
                pass
            else:
                # Get the CVE ID Year
                CVEIDYear=re.sub('^CVE-', '', row[0])
                CVEIDYear=re.sub('-[0-9]*$', '', CVEIDYear)

                # If we have an assignedDate value use it, and modify for prior reserved CVEs
                if re.search('Assigned \(', row[4]):
                    assignedDateYear=re.sub('^Assigned \(', '', row[4])
                    assignedDateYear=re.sub('[0-9][0-9][0-9][0-9]\)$', '', assignedDateYear)

                    # Add logic to check for reserved IDs from prior years, if so bump it up to the CVE Year in the ID itself
                    if int(assignedDateYear) < int(CVEIDYear):
                        assignedDateYear = CVEIDYear

                # If we do not have an assignedDate use the CVE year
                else:
                    assignedDateYear=CVEIDYear

                # Write to the correct year counter if assigned in later years
                if int(assignedDateYear) > int(CVEIDYear):
                    CVEAssignedYears[int(assignedDateYear)]["CVEsForPreviousYears"] += 1
                else:
                    CVEAssignedYears[int(assignedDateYear)]["CVEsforCurrentYear"] += 1

print("Year,CVECountforCurrentYear,CVECountForPreviousYears")

for entry in CVEAssignedYears:
        print(str(entry) + "," + str(CVEAssignedYears[entry]["CVEsForPreviousYears"]) + "," + str(CVEAssignedYears[entry]["CVEsforCurrentYear"]))
