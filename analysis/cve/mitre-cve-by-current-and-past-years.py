#!/usr/bin/env python3

import csv
import re
import os

os.system("wget -q https://cve.mitre.org/data/downloads/allitems.csv.gz")
os.system("gzip -d allitems.csv.gz")

CVEAssignedYears = {1999: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2000: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2001: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2002: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2003: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2004: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2005: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2006: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2007: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2008: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2009: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2010: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2011: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2012: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2013: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2014: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2015: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2016: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2017: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2018: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2019: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2020: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2021: {"assignedForCurrentYear":0, "assignedForPreviousYear":0},
                    2022: {"assignedForCurrentYear":0, "assignedForPreviousYear":0}
}

with open('allitems.csv', newline='',  encoding='ISO-8859-1') as csvfile:
    cvereader= csv.reader(csvfile, delimiter=',', quotechar='"')
    for row in cvereader:
        if re.search('^CVE-', row[0]):
            # Ignore reserved
            if re.search('^\*\* RESERVED \*\* ', row[2]):
                pass
            else:
                # Get the CVE ID Year
                CVEIDYear=re.sub('^CVE-', '', row[0])
                CVEIDYear=re.sub('-[0-9]*$', '', CVEIDYear)

                # If we have an assignedDate value use it, and modify for prior reserved CVEs
                if re.search('Assigned \(', row[4]):
                    assignedDateYear=re.sub('^Assigned \(', '', row[4])
                    assignedDateYear=re.sub('[0-9][0-9][0-9][0-9]\)$', '', assignedDateYear)

                    # Add logic to check for reserved IDs from prior years, if so bump it up to the CVE Year in the ID itself
                    if int(assignedDateYear) < int(CVEIDYear):
                        assignedDateYear = CVEIDYear

                # If we do not have an assignedDate use the CVE year
                else:
                    assignedDateYear=CVEIDYear

                # Write to the correct year counter if assigned in later years
                if int(assignedDateYear) > int(CVEIDYear):
                    CVEAssignedYears[int(assignedDateYear)]["assignedForPreviousYear"] += 1
                else:
                    CVEAssignedYears[int(assignedDateYear)]["assignedForCurrentYear"] += 1

print("Year,AssignedForCurrentYear,AssignedForPastYears")

for entry in CVEAssignedYears:
        print(str(entry) + "," + str(CVEAssignedYears[entry]["assignedForCurrentYear"]) + "," + str(CVEAssignedYears[entry]["assignedForPreviousYear"]))
